import sqlite3
import random
from datetime import datetime

# Path to your database
DB_FILE = "DB/pepsources.db"

def create_tables():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    # Create the users table
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            email TEXT UNIQUE NOT NULL,
            pfp TEXT,
            access_token TEXT,
            refresh_token TEXT,
            expires_in INTEGER
        );
    """)
    # Create the user_preferences table (if needed)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS user_preferences (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            preference TEXT NOT NULL
        );
    """)
    # Create the Reviews table with a foreign key linking to users
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS Reviews (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            account_id INTEGER NOT NULL,
            target_type TEXT NOT NULL,    -- 'drug' or 'vendor'
            target_id INTEGER NOT NULL,   -- ID of the drug or vendor being reviewed
            rating INTEGER NOT NULL,      -- e.g., 1 to 5 stars
            review_text TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (account_id) REFERENCES users(id) ON DELETE CASCADE
        );
    """)
    # Create the Drugs table
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS Drugs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT UNIQUE,
            last_checked TEXT
        );
    """)
    # Create the Vendors table (adjust column names if necessary)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS Vendors (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT,
            product_name TEXT,
            product_link TEXT,
            product_image TEXT,
            price TEXT,
            size TEXT,
            drug_id TEXT
        );
    """)
    conn.commit()
    conn.close()
    print("Tables created or verified successfully.")

def insert_dummy_users():
    dummy_users = [
        ("Alice Johnson", "alice@example.com", "https://example.com/images/alice.png", "dummy_access_token_1", "dummy_refresh_token_1", 3600),
        ("Bob Smith", "bob@example.com", "https://example.com/images/bob.png", "dummy_access_token_2", "dummy_refresh_token_2", 3600),
        ("Charlie Brown", "charlie@example.com", "https://example.com/images/charlie.png", "dummy_access_token_3", "dummy_refresh_token_3", 3600)
    ]
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    for user in dummy_users:
        try:
            cursor.execute("""
                INSERT INTO users (name, email, pfp, access_token, refresh_token, expires_in)
                VALUES (?, ?, ?, ?, ?, ?)
            """, user)
            print(f"Inserted user: {user[0]} ({user[1]})")
        except sqlite3.IntegrityError:
            print(f"User with email {user[1]} already exists. Skipping.")
    conn.commit()
    conn.close()

def get_all_users():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT id FROM users")
    users = [row["id"] for row in cursor.fetchall()]
    conn.close()
    return users

def get_all_drugs():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT id FROM Drugs")
    drugs = [row["id"] for row in cursor.fetchall()]
    conn.close()
    return drugs

def get_all_vendors():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT id FROM Vendors")
    vendors = [row["id"] for row in cursor.fetchall()]
    conn.close()
    return vendors

def insert_review(account_id, target_type, target_id, rating, review_text):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    created_at = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    cursor.execute("""
        INSERT INTO Reviews (account_id, target_type, target_id, rating, review_text, created_at)
        VALUES (?, ?, ?, ?, ?, ?)
    """, (account_id, target_type, target_id, rating, review_text, created_at))
    conn.commit()
    conn.close()

def insert_dummy_reviews():
    dummy_review_texts = [
        "Excellent product, really helped my research!",
        "I was very satisfied with the performance.",
        "Not as effective as I expected.",
        "Quality is decent, but could be improved.",
        "Amazing! I highly recommend this for studies.",
        "Great value for money and reliable results.",
        "I didn't notice a significant difference.",
        "Surprisingly good, exceeded my expectations!",
        "Mediocre results, not what I hoped for.",
        "Outstanding! Truly revolutionary in my lab."
    ]
    users = get_all_users()
    drugs = get_all_drugs()
    vendors = get_all_vendors()

    if not users:
        print("No users found in the database. Please insert dummy users first.")
        return
    if not drugs:
        print("No drugs found in the database.")
        return
    if not vendors:
        print("No vendors found in the database.")
        return

    # Insert one review per user for each drug
    for drug_id in drugs:
        for user_id in users:
            rating = random.randint(1, 5)
            review_text = random.choice(dummy_review_texts)
            insert_review(user_id, "drug", drug_id, rating, review_text)
            print(f"Inserted review for drug_id {drug_id} by user {user_id}")

    # Insert one review per user for each vendor
    for vendor_id in vendors:
        for user_id in users:
            rating = random.randint(1, 5)
            review_text = random.choice(dummy_review_texts)
            insert_review(user_id, "vendor", vendor_id, rating, review_text)
            print(f"Inserted review for vendor_id {vendor_id} by user {user_id}")

    print("Dummy reviews inserted successfully!")

def main():
    create_tables()
    insert_dummy_users()
    insert_dummy_reviews()

if __name__ == "__main__":
    main()