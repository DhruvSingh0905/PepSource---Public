#!/usr/bin/env python3
import os
import sqlite3
import logging
from supabase import create_client
from dotenv import load_dotenv

# Load environment variables and configure logging
load_dotenv()
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger("form_column_upsert")

# Database paths and connection details
DB_FILE = "DB/pepsources.db"
SUPABASE_URL = os.getenv("VITE_SUPABASE_URL")
SUPABASE_SERVICE_KEY = os.getenv("VITE_SUPABASE_SERVICE_KEY")

def upsert_form_column_to_supabase():
    """
    Retrieves vendors with form classifications from the local SQLite database
    and upserts them to Supabase's vendors table.
    """
    if not SUPABASE_URL or not SUPABASE_SERVICE_KEY:
        logger.error("Supabase credentials are not set.")
        return False
    
    # Connect to local SQLite database
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    
    # Check if form column exists in SQLite
    cursor.execute("PRAGMA table_info(Vendors)")
    columns = [info[1] for info in cursor.fetchall()]
    
    if 'form' not in columns:
        logger.error("Form column does not exist in local Vendors table.")
        conn.close()
        return False
    
    # Get vendors with form data
    cursor.execute("""
        SELECT id, name, form
        FROM Vendors
        WHERE form IS NOT NULL
    """)
    vendors = [dict(row) for row in cursor.fetchall()]
    
    if not vendors:
        logger.info("No vendors with form classification found.")
        conn.close()
        return True
    
    logger.info(f"Found {len(vendors)} vendors with form classification to upsert.")
    
    # Connect to Supabase
    try:
        supabase = create_client(SUPABASE_URL, SUPABASE_SERVICE_KEY)
        
        # First, ensure form column exists in Supabase
        try:
            # Try to get one row with form column to check if it exists
            supabase.table("vendors").select("form").limit(1).execute()
            logger.info("Form column exists in Supabase vendors table")
        except Exception as e:
            logger.warning(f"Error checking form column: {e}")
            logger.info("Adding form column to Supabase vendors table...")
            
            # Add form column if it doesn't exist
            sql_query = "ALTER TABLE vendors ADD COLUMN IF NOT EXISTS form TEXT;"
            conn_supabase = supabase.postgrest.connection
            conn_supabase.execute(sql_query)
            logger.info("Added form column to Supabase vendors table")
        
        # Prepare data for upsert - just the id and form column
        upsert_data = [{"id": vendor["id"], "form": vendor["form"]} for vendor in vendors]
        
        # Upsert in batches to avoid payload size issues
        BATCH_SIZE = 100
        for i in range(0, len(upsert_data), BATCH_SIZE):
            batch = upsert_data[i:i+BATCH_SIZE]
            response = supabase.table("vendors").upsert(batch, on_conflict="id").execute()
            logger.info(f"Upserted batch {i//BATCH_SIZE + 1}: {len(batch)} vendors")
        
        logger.info(f"Successfully upserted form data for {len(vendors)} vendors to Supabase")
        conn.close()
        return True
        
    except Exception as e:
        logger.error(f"Error upserting form data to Supabase: {e}")
        conn.close()
        return False

if __name__ == "__main__":
    logger.info("Starting form column upsert process")
    success = upsert_form_column_to_supabase()
    if success:
        logger.info("Form column upsert completed successfully")
    else:
        logger.error("Form column upsert process failed")