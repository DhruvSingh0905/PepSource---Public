#!/usr/bin/env python3
import os
import sqlite3
import logging
from dotenv import load_dotenv

# Load environment variables from .env
load_dotenv()

# Configuration
DB_FILE = "DB/pepsources.db"

# Setup logging
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger("delete_researchchem_vendors")

def delete_researchchem_vendors():
    """
    Delete all vendors with name 'ResearchChem' from the database.
    """
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    
    try:
        # First, count how many will be deleted
        cursor.execute("SELECT COUNT(*) FROM Vendors WHERE name = 'ResearchChem'")
        count = cursor.fetchone()[0]
        
        if count == 0:
            logger.info("No vendors with name 'ResearchChem' found.")
            return 0
        
        # Begin transaction
        cursor.execute("BEGIN TRANSACTION")
        
        # Delete the vendors
        cursor.execute("DELETE FROM Vendors WHERE name = 'ResearchChem'")
        
        # Commit transaction
        cursor.execute("COMMIT")
        
        logger.info(f"Successfully deleted {count} vendors with name 'ResearchChem'.")
        return count
    except sqlite3.Error as e:
        cursor.execute("ROLLBACK")
        logger.error(f"Error deleting ResearchChem vendors: {e}")
        return 0
    finally:
        conn.close()

if __name__ == "__main__":
    try:
        logger.info("Starting deletion of ResearchChem vendors...")
        count = delete_researchchem_vendors()
        logger.info(f"Deletion complete. {count} vendors removed.")
    except Exception as e:
        logger.error(f"Script execution failed: {e}")