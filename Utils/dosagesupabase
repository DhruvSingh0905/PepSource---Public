#!/usr/bin/env python3
import os
import sqlite3
import logging
from supabase import create_client
from dotenv import load_dotenv

# Set up logging
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger("dosing_advice_upsert")

# Load environment variables and connect to clients
load_dotenv()
SUPABASE_URL = os.getenv("VITE_SUPABASE_URL")
SUPABASE_SERVICE_KEY = os.getenv("VITE_SUPABASE_SERVICE_KEY")

if not SUPABASE_URL or not SUPABASE_SERVICE_KEY:
    logger.error("Supabase credentials are not set.")
    exit(1)

# Connect to SQLite DB
DB_FILE = "DB/pepsources.db"
conn = sqlite3.connect(DB_FILE)
conn.row_factory = sqlite3.Row
cursor = conn.cursor()

# Connect to Supabase
supabase = create_client(SUPABASE_URL, SUPABASE_SERVICE_KEY)

def upsert_dosing_advice_to_supabase():
    """
    Upserts dosing advice from local DB to Supabase.
    Only upserts records that have at least one non-null dosing field.
    """
    # Fetch drugs with any non-null dosing advice
    cursor.execute("""
        SELECT id, name, proper_name, obese_dosing, skinny_with_little_muscle_dosing, muscular_dosing
        FROM Drugs
        WHERE obese_dosing IS NOT NULL 
           OR skinny_with_little_muscle_dosing IS NOT NULL 
           OR muscular_dosing IS NOT NULL
    """)
    
    drugs = [dict(row) for row in cursor.fetchall()]
    
    if not drugs:
        logger.info("No drugs with dosing advice found.")
        return 0
    
    logger.info(f"Found {len(drugs)} drugs with dosing advice.")
    
    # Prepare for batch upsert
    batches = []
    batch_size = 50  # Process in smaller batches to avoid payload size issues
    
    for i in range(0, len(drugs), batch_size):
        batch = drugs[i:i+batch_size]
        
        # Process each batch
        upsert_data = []
        for drug in batch:
            # Only include fields that have dosing data
            update_fields = {"id": drug["id"]}
            
            if drug.get("obese_dosing"):
                update_fields["obese_dosing"] = drug["obese_dosing"]
            
            if drug.get("skinny_with_little_muscle_dosing"):
                update_fields["skinny_with_little_muscle_dosing"] = drug["skinny_with_little_muscle_dosing"]
            
            if drug.get("muscular_dosing"):
                update_fields["muscular_dosing"] = drug["muscular_dosing"]
            
            # Only add to upsert if there's at least one dosing field
            if len(update_fields) > 1:  # More than just the ID
                upsert_data.append(update_fields)
        
        if upsert_data:
            batches.append(upsert_data)
    
    # Perform the upserts
    total_upserted = 0
    
    for i, batch_data in enumerate(batches):
        try:
            response = supabase.table("drugs").upsert(batch_data).execute()
            batch_count = len(batch_data)
            total_upserted += batch_count
            logger.info(f"Upserted batch {i+1}/{len(batches)}: {batch_count} drugs")
        except Exception as e:
            logger.error(f"Error upserting batch {i+1}: {e}")
    
    logger.info(f"Successfully upserted dosing advice for {total_upserted} drugs to Supabase")
    return total_upserted

if __name__ == "__main__":
    try:
        logger.info("Starting dosing advice upsert process")
        count = upsert_dosing_advice_to_supabase()
        logger.info(f"Dosing advice upsert completed. Processed {count} drugs.")
    except Exception as e:
        logger.error(f"Error in dosing advice upsert: {e}")
    finally:
        conn.close()