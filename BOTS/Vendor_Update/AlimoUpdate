#!/usr/bin/env python3
import os
import time
import sqlite3
import re
import random
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait, Select
from selenium.webdriver.support import expected_conditions as EC
from fake_useragent import UserAgent
from dotenv import load_dotenv

# Load environment variables from .env
load_dotenv()

# ------------------- SELENIUM CONFIGURATION -------------------
def configure_selenium():
    ua = UserAgent()
    options = Options()
    options.add_argument("--headless")  # Run in headless mode for production; remove for debugging
    options.add_argument("--disable-gpu")
    options.add_argument("--no-sandbox")
    options.add_argument("--disable-dev-shm-usage")
    options.add_argument("--disable-blink-features=AutomationControlled")
    options.add_argument(f"--user-agent={ua.random}")
    driver = webdriver.Chrome(options=options)
    driver.implicitly_wait(5)
    # Bypass CSP and security warnings
    driver.execute_cdp_cmd("Page.enable", {})
    driver.execute_cdp_cmd("Page.setBypassCSP", {"enabled": True})
    return driver

def random_delay(min_time=2, max_time=5):
    """Introduce a random delay to mimic human behavior."""
    time.sleep(random.uniform(min_time, max_time))

# ------------------- PRICE EXTRACTION -------------------
def extract_updated_price(driver):
    """
    Extracts the updated price from the current page using a CSS selector.
    Returns the matched price string (e.g. "$123.45") or None if not found.
    """
    try:
        price_element = WebDriverWait(driver, 5).until(
            EC.presence_of_element_located((By.CSS_SELECTOR, ".woocommerce-variation-price .price"))
        )
        price_html = price_element.get_attribute("innerHTML")
        price_match = re.search(r"\$([\d,\.]+)", price_html)
        if price_match:
            return price_match.group(0)
    except Exception as e:
        print(f"[ERROR] Extracting price failed: {e}")
    return None

# ------------------- MAIN SCRIPT -------------------
def main():
    # Path to your local SQLite database
    DB_FILE = "DB/pepsources.db"
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # Set the vendor name to update (adjust as necessary)
    vendor_name = "Alimo Peptides"

    # Fetch all vendor rows for the given vendor name
    cursor.execute("SELECT id, product_link FROM Vendors WHERE name = ?", (vendor_name,))
    vendor_rows = cursor.fetchall()
    print(f"[INFO] Found {len(vendor_rows)} vendor rows for vendor '{vendor_name}'.")

    # Set up Selenium driver
    driver = configure_selenium()

    for vendor in vendor_rows:
        vendor_id, product_link = vendor
        print(f"[INFO] Processing vendor id {vendor_id} with link: {product_link}")
        try:
            driver.get(product_link)
            random_delay(3, 7)
            updated_price = extract_updated_price(driver)
            if updated_price:
                cursor.execute("UPDATE Vendors SET price = ? WHERE id = ?", (updated_price, vendor_id))
                conn.commit()
                print(f"[INFO] Updated vendor id {vendor_id} with new price: {updated_price}")
            else:
                print(f"[WARN] Could not extract updated price for vendor id {vendor_id}.")
        except Exception as e:
            print(f"[ERROR] Processing vendor id {vendor_id} failed: {e}")
        random_delay(1, 2)

    driver.quit()
    conn.close()
    print("[INFO] Price update complete.")

if __name__ == "__main__":
    main()